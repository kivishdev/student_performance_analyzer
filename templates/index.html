<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Student Insights AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; color: #f8fafc; }
        
        .glass {
            background: rgba(30, 41, 59, 0.75);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .gradient-text {
            background: linear-gradient(135deg, #2dd4bf 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .blob {
            position: absolute;
            filter: blur(90px);
            z-index: -1;
            opacity: 0.3;
            animation: move 12s infinite alternate;
        }
        @keyframes move { from { transform: translate(0,0); } to { transform: translate(40px, 40px); } }

        /* Enhanced Scrollbar for PC */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; border: 2px solid rgba(30, 41, 59, 0.5); }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Mobile specific adjustments */
        .mobile-height { height: 100dvh; }
        
        .markdown-body h3 { color: #5eead4; font-weight: 700; margin-top: 1rem; margin-bottom: 0.5rem; font-size: 1.1rem; }
        .markdown-body ul { list-style: disc; padding-left: 1.2rem; color: #cbd5e1; }
        .markdown-body strong { color: white; }
        
        .mode-btn { transition: all 0.2s; }
        .mode-btn.active { background-color: rgba(45, 212, 191, 0.15); border-color: #2dd4bf; color: #5eead4; }
        .mode-btn:not(.active) { background-color: rgba(30, 41, 59, 0.5); border-color: #475569; color: #94a3b8; }
        .mode-btn:not(.active):hover { border-color: #2dd4bf; }

        /* Popup Animation */
        .modal-enter { animation: modalIn 0.3s ease-out forwards; }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
    </style>
</head>
<body class="mobile-height flex flex-col overflow-hidden">

    <!-- Background -->
    <div class="blob bg-purple-600 w-80 h-80 rounded-full top-0 left-0"></div>
    <div class="blob bg-teal-600 w-80 h-80 rounded-full bottom-0 right-0"></div>

    <!-- Header -->
    <nav class="glass z-50 px-4 py-3 flex justify-between items-center shadow-lg shrink-0">
        <div class="flex items-center gap-2">
            <i class="fas fa-brain text-xl text-teal-400"></i>
            <h1 class="text-xl font-bold tracking-tight">Student<span class="gradient-text">Insights</span></h1>
        </div>
        
        <div class="flex gap-2 bg-slate-800/50 p-1 rounded-lg">
            <button onclick="switchTab('analyze')" id="tab-analyze" class="px-3 py-1.5 rounded-md text-sm font-medium transition bg-slate-700 text-white shadow">Analyze</button>
            <button onclick="switchTab('career')" id="tab-career" class="px-3 py-1.5 rounded-md text-sm font-medium transition text-slate-400 hover:text-white">Career</button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 relative overflow-hidden flex flex-col md:flex-row min-h-0">
        
        <!-- SECTION 1: ANALYZER -->
        <div id="panel-analyze" class="w-full h-full flex flex-col md:flex-row transition-all duration-300">
            
            <!-- Input Column -->
            <div class="w-full md:w-1/3 p-4 md:p-6 flex flex-col gap-4 overflow-y-auto border-r border-slate-700 bg-slate-900/60 z-20 shrink-0 custom-scroll">
                <div class="space-y-3">
                    <h2 class="text-lg font-semibold text-white flex items-center gap-2"><i class="fas fa-file-import text-teal-400"></i> Data Source</h2>
                    
                    <div class="border-2 border-dashed border-slate-600 rounded-xl p-6 text-center hover:border-teal-500 hover:bg-slate-800/50 transition cursor-pointer relative group">
                        <input type="file" id="fileInput" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".csv,.xlsx,.xls,.txt,.pdf">
                        <i class="fas fa-cloud-upload-alt text-2xl text-slate-500 group-hover:text-teal-400 mb-2 transition"></i>
                        <p id="fileName" class="text-sm font-medium text-slate-300">Upload PDF, Excel, CSV</p>
                        <p class="text-xs text-slate-500 mt-1">Supports Marks sheets & Resumes</p>
                    </div>

                    <div class="text-center text-xs text-slate-500 uppercase tracking-wider font-semibold">- OR -</div>

                    <textarea id="textInput" class="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-3 text-sm focus:ring-2 focus:ring-teal-500 outline-none transition h-20 resize-none" placeholder="Enter Marks in Text Here...
                    For ex: John doe
                    Maths: 90/100"></textarea>
                </div>

                <div class="space-y-2">
                    <h2 class="text-sm font-semibold text-slate-300 uppercase tracking-wide">Analysis Mode</h2>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="selectMode(1, this)" class="mode-btn p-3 rounded-lg border text-sm font-medium flex flex-col items-center justify-center gap-1">
                            <i class="fas fa-user"></i> Individual
                        </button>
                        <button onclick="selectMode(2, this)" class="mode-btn p-3 rounded-lg border text-sm font-medium flex flex-col items-center justify-center gap-1">
                            <i class="fas fa-users"></i> Comparative
                        </button>
                        <button onclick="selectMode(3, this)" class="mode-btn active p-3 rounded-lg border text-sm font-medium flex flex-col items-center justify-center gap-1">
                            <i class="fas fa-layer-group"></i> Both
                        </button>
                        <button onclick="selectMode(4, this)" class="mode-btn p-3 rounded-lg border text-sm font-medium flex flex-col items-center justify-center gap-1">
                            <i class="fas fa-file-invoice"></i> Resume / CV
                        </button>
                    </div>
                    <input type="hidden" id="analysisType" value="3">
                </div>

                <div class="mt-auto pt-4 pb-20 md:pb-0">
                    <button id="generateBtn" class="w-full bg-gradient-to-r from-teal-500 to-blue-600 hover:from-teal-400 hover:to-blue-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-teal-500/20 transition transform active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span>Analyze Data</span> <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Results Column (Scroll Fix: h-full + overflow-y-auto) -->
            <div class="flex-1 bg-slate-900/30 p-4 md:p-6 overflow-y-auto relative min-h-0 h-full custom-scroll" id="results-area">
                <div id="state-empty" class="h-full flex flex-col items-center justify-center text-slate-500 opacity-60">
                    <i class="fas fa-chart-simple text-5xl mb-3"></i>
                    <p>Select options & Analyze</p>
                </div>

                <div id="state-loading" class="hidden h-full flex flex-col items-center justify-center">
                    <div class="w-12 h-12 border-4 border-teal-500 border-t-transparent rounded-full animate-spin mb-3"></div>
                    <p class="text-teal-400 animate-pulse text-sm font-medium">Processing...</p>
                </div>

                <div id="state-content" class="hidden space-y-4 pb-20">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-white font-semibold">Results</h3>
                        <div class="flex gap-2">
                            <button onclick="copyResults()" class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded transition"><i class="fas fa-copy mr-1"></i> Copy</button>
                            <button onclick="downloadReport()" class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded transition"><i class="fas fa-download mr-1"></i> Save</button>
                        </div>
                    </div>

                    <div id="chart-wrapper" class="hidden glass rounded-xl p-4">
                        <div class="relative h-56 w-full">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>

                    <div id="text-result" class="glass rounded-xl p-5 markdown-body text-sm"></div>
                </div>
            </div>
        </div>

        <!-- SECTION 2: CAREER GUIDE -->
        <div id="panel-career" class="hidden w-full h-full flex-col max-w-3xl mx-auto p-4 md:p-6 min-h-0">
            <div class="glass flex-1 rounded-2xl flex flex-col overflow-hidden border border-slate-700">
                <div class="p-4 border-b border-slate-700 bg-slate-800/40 flex justify-between items-center shrink-0">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                            <i class="fas fa-compass text-white text-xs"></i>
                        </div>
                        <div>
                            <h2 class="text-sm font-bold text-white">Career Pathfinder</h2>
                            <p class="text-xs text-slate-400">AI Counselor</p>
                        </div>
                    </div>
                    <div class="flex bg-slate-900 rounded-lg p-1 text-xs">
                        <button onclick="setCareerMode('chat')" id="mode-chat" class="px-3 py-1 rounded bg-slate-700 text-white transition">Chat</button>
                        <button onclick="setCareerMode('roadmap')" id="mode-roadmap" class="px-3 py-1 rounded text-slate-400 hover:text-white transition"><i class="fas fa-map mr-1"></i>Map</button>
                    </div>
                </div>

                <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900/20 custom-scroll">
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center flex-shrink-0 text-white text-xs"><i class="fas fa-robot"></i></div>
                        <div class="bg-slate-800 p-3 rounded-lg rounded-tl-none max-w-[85%] text-sm text-slate-200 shadow-sm border border-slate-700">
                            Hi! Ask me anything about your career or upload your resume in the Analysis tab!
                        </div>
                    </div>
                </div>

                <div class="p-3 bg-slate-800/50 border-t border-slate-700 shrink-0">
                    <form id="chat-form" class="flex gap-2">
                        <input type="text" id="chat-input" class="flex-1 bg-slate-900 border border-slate-700 rounded-xl px-4 py-2.5 focus:ring-1 focus:ring-purple-500 outline-none text-white text-sm placeholder-slate-500 transition" placeholder="Ask about jobs or skills..." autocomplete="off">
                        <button type="submit" id="chat-submit-btn" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-xl transition shadow-lg shadow-purple-500/20"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>
        </div>

    </main>

    <!-- Unified Mobile Modal (Used for BOTH Analysis & Career) -->
    <div id="mobile-modal" class="fixed inset-0 z-50 hidden md:hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeModal()"></div>
        <!-- Content -->
        <div class="absolute bottom-0 left-0 right-0 bg-slate-900 rounded-t-2xl border-t border-slate-700 shadow-2xl modal-enter max-h-[85vh] flex flex-col">
            <div class="p-4 border-b border-slate-800 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-2 text-teal-400 font-bold">
                    <i class="fas fa-sparkles"></i> AI Result
                </div>
                <button onclick="closeModal()" class="w-8 h-8 bg-slate-800 rounded-full text-slate-400 hover:text-white flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div id="mobile-modal-content" class="p-5 overflow-y-auto markdown-body text-sm text-slate-200 leading-relaxed custom-scroll">
                <!-- Content injected here -->
            </div>
        </div>
    </div>

    <script>
        // --- UI Logic ---
        function switchTab(tab) {
            const analyzePanel = document.getElementById('panel-analyze');
            const careerPanel = document.getElementById('panel-career');
            const btnAnalyze = document.getElementById('tab-analyze');
            const btnCareer = document.getElementById('tab-career');

            if (tab === 'analyze') {
                analyzePanel.classList.remove('hidden');
                analyzePanel.classList.add('flex');
                careerPanel.classList.add('hidden');
                careerPanel.classList.remove('flex');
                
                btnAnalyze.className = "px-3 py-1.5 rounded-md text-sm font-medium transition bg-slate-700 text-white shadow";
                btnCareer.className = "px-3 py-1.5 rounded-md text-sm font-medium transition text-slate-400 hover:text-white";
            } else {
                analyzePanel.classList.add('hidden');
                analyzePanel.classList.remove('flex');
                careerPanel.classList.remove('hidden');
                careerPanel.classList.add('flex');

                btnCareer.className = "px-3 py-1.5 rounded-md text-sm font-medium transition bg-purple-600 text-white shadow";
                btnAnalyze.className = "px-3 py-1.5 rounded-md text-sm font-medium transition text-slate-400 hover:text-white";
            }
        }

        function selectMode(type, btn) {
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('analysisType').value = type;
        }

        // --- Analyze Logic ---
        const fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                document.getElementById('fileName').innerText = e.target.files[0].name;
                document.getElementById('fileName').classList.add('text-teal-400');
            }
        });

        let myChart = null;
        document.getElementById('generateBtn').addEventListener('click', async () => {
            const formData = new FormData();
            formData.append('file', fileInput.files[0] || '');
            formData.append('text_input', document.getElementById('textInput').value);
            formData.append('analysis_type', document.getElementById('analysisType').value);
            
            document.getElementById('state-empty').classList.add('hidden');
            document.getElementById('state-content').classList.add('hidden');
            document.getElementById('state-loading').classList.remove('hidden');
            
            // Scroll only on desktop if needed, mobile uses modal
            if(window.innerWidth >= 768) {
                // Desktop logic handled by CSS flex
            }

            try {
                const res = await fetch('/api/analyze', { method: 'POST', body: formData });
                const data = await res.json();
                
                if (data.error) throw new Error(data.error);

                document.getElementById('state-loading').classList.add('hidden');
                
                // Construct result text
                let content = "";
                if(data.text_results.resume) content += data.text_results.resume;
                else content = (data.text_results.standard || "") + "\n\n" + (data.text_results.comparative || "");
                
                // MOBILE: Show in Modal
                if (window.innerWidth < 768) {
                    showModal(content);
                    // Also reset empty state so background doesn't look broken
                    document.getElementById('state-empty').classList.remove('hidden');
                } else {
                    // DESKTOP: Show in panel
                    document.getElementById('state-content').classList.remove('hidden');
                    document.getElementById('text-result').innerHTML = marked.parse(content);
                }

                // Handle Chart (Desktop only generally, or inside panel)
                const chartWrapper = document.getElementById('chart-wrapper');
                if (data.chart_data && window.innerWidth >= 768) {
                    chartWrapper.classList.remove('hidden');
                    renderChart(data.chart_data);
                } else {
                    chartWrapper.classList.add('hidden');
                }

            } catch (err) {
                document.getElementById('state-loading').classList.add('hidden');
                const errMsg = "Error: " + err.message;
                alert(errMsg);
                document.getElementById('state-empty').classList.remove('hidden');
            }
        });

        function renderChart(data) {
            if (myChart) myChart.destroy();
            const ctx = document.getElementById('performanceChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Avg Score',
                        data: data.values,
                        backgroundColor: '#2dd4bf',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        x: { display: false }
                    }
                }
            });
        }

        function downloadReport() {
            const txt = document.getElementById('text-result').innerText;
            const blob = new Blob([txt], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'analysis.txt';
            a.click();
        }

        function copyResults() {
             const txt = document.getElementById('text-result').innerText;
             navigator.clipboard.writeText(txt);
             alert("Copied to clipboard");
        }

        // --- Career Logic ---
        let careerMode = 'chat';
        function setCareerMode(mode) {
            careerMode = mode;
            const btnChat = document.getElementById('mode-chat');
            const btnMap = document.getElementById('mode-roadmap');
            
            if (mode === 'chat') {
                btnChat.className = "px-3 py-1 rounded bg-slate-700 text-white transition";
                btnMap.className = "px-3 py-1 rounded text-slate-400 hover:text-white transition";
                document.getElementById('chat-input').placeholder = "Ask a career question...";
            } else {
                btnMap.className = "px-3 py-1 rounded bg-purple-600 text-white transition";
                btnChat.className = "px-3 py-1 rounded text-slate-400 hover:text-white transition";
                document.getElementById('chat-input').placeholder = "Enter a job title (e.g. Data Scientist)...";
            }
        }

        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const btn = document.getElementById('chat-submit-btn');
            const msg = input.value.trim();
            if(!msg) return;

            addMsg(msg, 'user');
            input.value = '';
            
            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const res = await fetch('/api/career-guide', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: msg, mode: careerMode })
                });
                const data = await res.json();
                
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i>';

                if(data.error) throw new Error(data.error);
                
                // MOBILE: Show in Modal
                if (window.innerWidth < 768) {
                    showModal(data.response);
                } 
                // ALWAYS: Add to chat history
                addMsg(data.response, 'ai');
                
            } catch (err) {
                console.error(err);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                const errText = "Sorry, I couldn't reach the AI server. Please try again.";
                if (window.innerWidth < 768) showModal(errText);
                addMsg(errText, 'ai');
            }
        });

        function addMsg(text, sender) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `flex items-start gap-3 ${sender === 'user' ? 'flex-row-reverse' : ''}`;
            
            const content = marked.parse(text);
            
            const bubble = `
                <div class="${sender === 'ai' ? 'bg-slate-800 text-slate-200 border border-slate-700' : 'bg-purple-600 text-white'} p-3 rounded-lg ${sender === 'ai' ? 'rounded-tl-none' : 'rounded-tr-none'} max-w-[85%] text-sm shadow-sm markdown-body">
                    ${content}
                </div>
            `;
            const icon = sender === 'ai' 
                ? '<div class="w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center flex-shrink-0 text-white text-xs"><i class="fas fa-robot"></i></div>'
                : '<div class="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center flex-shrink-0 text-white text-xs"><i class="fas fa-user"></i></div>';

            div.innerHTML = icon + bubble;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // Modal Logic
        function showModal(content) {
            const modal = document.getElementById('mobile-modal');
            const modalContent = document.getElementById('mobile-modal-content');
            modalContent.innerHTML = marked.parse(content);
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('mobile-modal').classList.add('hidden');
        }
    </script>
</body>
</html>